name: SAPå¤šè´¦æˆ·ä»…ä¿æ´»
# è¯·è®¾ä¸ºç§åº“ï¼ï¼ï¼
on:
  workflow_dispatch:

concurrency:
  group: keepalive
  cancel-in-progress: true

jobs:
  deploy-app:
    runs-on: ubuntu-latest
    env:
      # å¿…å¡«ï¼æ¯ä¸ªè´¦å·é‚®ç®±ç©ºä¸€æ ¼
      CF_USERNAMES: "" 

      # å¿…å¡«ï¼æ¯ä¸ªè´¦å·å¯¹åº”å¯†ç ç©ºä¸€æ ¼
      CF_PASSWORDS: ""

      # å¿…å¡«ï¼æ¯ä¸ªè´¦å·å¯¹åº”åœ°åŒºç©ºä¸€æ ¼
      REGIONS: "" 

      # å¿…å¡«ï¼æ¯ä¸ªè´¦å·å¯¹åº”UUIDç©ºä¸€æ ¼
      UUIDS: "" 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Cloud Foundry CLI
        run: |
          wget -q https://github.com/cloudfoundry/cli/releases/download/v8.16.0/cf8-cli_8.16.0_linux_x86-64.tgz
          tar -xzf cf8-cli_8.16.0_linux_x86-64.tgz
          sudo mv cf8 /usr/local/bin/cf8
          sudo ln -sf /usr/local/bin/cf8 /usr/local/bin/cf
          sudo chmod +x /usr/local/bin/cf8

      - name: deployment
        run: |
          read -ra CF_USERNAMES <<< "$CF_USERNAMES"
          read -ra CF_PASSWORDS <<< "$CF_PASSWORDS"
          read -ra REGIONS <<< "$REGIONS"
          read -ra UUIDS <<< "$UUIDS"
          echo "*****************************************************"
          echo "*****************************************************"
          echo "ç”¬å“¥Githubé¡¹ç›®  ï¼šgithub.com/yonggekkk"
          echo "ç”¬å“¥Bloggeråšå®¢ ï¼šygkkk.blogspot.com"
          echo "ç”¬å“¥YouTubeé¢‘é“ ï¼šwww.youtube.com/@ygkkk"
          echo "Argosbxå°é’¢ç‚®è„šæœ¬-SAPå¤šè´¦æˆ·ä¿æ´»è„šæœ¬ã€Githubã€‘"
          echo "ç‰ˆæœ¬ï¼šV25.10.19"
          echo "*****************************************************"
          echo "*****************************************************"
          pushout(){
            if echo "$push_out" | grep -iq "insufficient"; then
              echo "ğŸ”´ç¬¬ $((i+1)) ä¸ªå®ä¾‹éƒ¨ç½²ï¼š$apps å¤±è´¥äº†ï¼ŒSAPèµ„æºè¢«äººæŠ¢å…‰äº†ï¼Œæ˜æ—©8:15-9:00å†æ¥å§ï¼Œå†è§ï¼ï¼"
              return 1
            elif echo "$push_out" | grep -q "mapped"; then
              echo "ğŸ”´ç¬¬ $((i+1)) ä¸ªå®ä¾‹éƒ¨ç½²ï¼š$apps å¤±è´¥äº†ï¼Œè¯·æ›´æ¢åº”ç”¨ç¨‹åºAPPåç§°ï¼š$appsï¼Œå†è¿è¡Œä¸€æ¬¡"
              return 1
            elif echo "$push_out" | grep -q "FAILED"; then
              echo "ğŸ”´ç¬¬ $((i+1)) ä¸ªå®ä¾‹éƒ¨ç½²ï¼š$apps å¤±è´¥äº†ï¼ŒSAPç¹å¿™ä¸­ï¼è¯·è‡ªæŸ¥å‚æ•°è®¾ç½®æ˜¯å¦æœ‰è¯¯ï¼Œåå°å®ä¾‹æ˜¯å¦è¶…é…é¢"
              return 1
            else
              echo "$apps å®Œæˆ"
              return 0
            fi
          }
          result(){
            ROUTE=$(cf app "$apps" | grep "routes:" | awk '{print $2}')
            url="https://$ROUTE/$UUID"
            if curl -s "$url" | grep -iq "requested"; then
            echo "ğŸ”´ $apps SAPåˆ›å»ºå¤±è´¥ï¼ŒSAPèµ„æºè¢«äººæŠ¢å…‰äº†ï¼Œæ˜æ—©8:10-9:00å†æ¥å§ï¼Œå†è§ï¼ï¼"
            return 1
            else
            echo "ğŸš€ç¬¬ $((i+1)) ä¸ªå®ä¾‹éƒ¨ç½²æˆåŠŸ"
            echo "ğŸŸ¢å®ä¾‹åç§°: $apps"
            echo "ğŸŸ¢æœåŠ¡å™¨åœ°åŒº: $REGION"
            echo "ğŸŒç‚¹å‡»æ‰“å¼€ä»£ç†èŠ‚ç‚¹çš„é“¾æ¥ç½‘å€ğŸ”—: https://$ROUTE/$UUID"
            echo
            return 0
            fi
          }
          for i in "${!CF_USERNAMES[@]}"; do
            set +e
            CF_EMAIL="${CF_USERNAMES[$i]}"
            CF_PASSWORD="${CF_PASSWORDS[$i]}"
            REGION="${REGIONS[$i]}"
            UUID="${UUIDS[$i]}"
            case "$REGION" in
            SG) CF_API="https://api.cf.ap21.hana.ondemand.com" ;;
            US) CF_API="https://api.cf.us10-001.hana.ondemand.com" ;;
            AU-A) CF_API="https://api.cf.ap10.hana.ondemand.com" ;;
            BR-A) CF_API="https://api.cf.br10.hana.ondemand.com" ;;
            KR-A) CF_API="https://api.cf.ap12.hana.ondemand.com" ;;
            CA-A) CF_API="https://api.cf.ca10.hana.ondemand.com" ;;
            US-V-A) CF_API="https://api.cf.us10-001.hana.ondemand.com" ;;
            US-O-A) CF_API="https://api.cf.us11.hana.ondemand.com" ;;
            DE-A) CF_API="https://api.cf.eu10-005.hana.ondemand.com" ;;
            JP-A) CF_API="https://api.cf.jp10.hana.ondemand.com" ;;
            SG-A) CF_API="https://api.cf.ap11.hana.ondemand.com" ;;
            AU-G) CF_API="https://api.cf.ap30.hana.ondemand.com" ;;
            BR-G) CF_API="https://api.cf.br30.hana.ondemand.com" ;;
            US-G) CF_API="https://api.cf.us30.hana.ondemand.com" ;;
            DE-G) CF_API="https://api.cf.eu30.hana.ondemand.com" ;;
            JP-O-G) CF_API="https://api.cf.jp30.hana.ondemand.com" ;;
            JP-T-G) CF_API="https://api.cf.jp31.hana.ondemand.com" ;;
            IL-G) CF_API="https://api.cf.il30.hana.ondemand.com" ;;
            IN-G) CF_API="https://api.cf.in30.hana.ondemand.com" ;;
            SA-G) CF_API="https://api.cf.sa31.hana.ondemand.com" ;;
            AU-M) CF_API="https://api.cf.ap20.hana.ondemand.com" ;;
            BR-M) CF_API="https://api.cf.br20.hana.ondemand.com" ;;
            CA-M) CF_API="https://api.cf.ca20.hana.ondemand.com" ;;
            US-V-M) CF_API="https://api.cf.us21.hana.ondemand.com" ;;
            US-W-M) CF_API="https://api.cf.us20.hana.ondemand.com" ;;
            NL-M) CF_API="https://api.cf.eu20-001.hana.ondemand.com" ;;
            JP-M) CF_API="https://api.cf.jp20.hana.ondemand.com" ;;
            SG-M) CF_API="https://api.cf.ap21.hana.ondemand.com" ;;
            AE-N) CF_API="https://api.cf.neo-ae1.hana.ondemand.com" ;;
            SA-N) CF_API="https://api.cf.neo-sa1.hana.ondemand.com" ;;            
            *) echo "æœªçŸ¥åŒºåŸŸ: $REGION"; continue ;;
            esac
            echo "=============================================="
            echo "=========ç¬¬ $((i+1)) ä¸ªå®ä¾‹å¼€å§‹å¯åŠ¨============"
            echo "=============================================="
            cf login -a "$CF_API" -u "$CF_EMAIL" -p "$CF_PASSWORD"
            ORG=$(cf orgs | sed -n '4p')
            SPACE=$(cf spaces | sed -n '4p')
            cf target -o "$ORG" -s "$SPACE"
            echo "ğŸ” ç™»å½• SAP Cloud Foundry"
            apps=$(cf apps | awk 'NR>3 {print $1}' | grep -v '^$')
            ROUTE=$(cf app "$apps" | grep "routes:" | awk '{print $2}')
            if [ -n "$ROUTE" ]; then
            url="https://$ROUTE/$UUID"
            if curl -s "$url" | grep -iq "vless"; then
              echo "âœ… $apps æ­£åœ¨è¿è¡Œä¸­ï¼Œè·³è¿‡æ‰§è¡Œã€‚"
              result
              continue
            else
              echo "ğŸŸ¡$apps å·²éƒ¨ç½²ï¼Œä½†æœªå¯åŠ¨ï¼Œç°é‡å¯â€¦â€¦"
              push_out="$(timeout 180 cf restart "$apps" 2>&1)"
              pushout
              if [ $? -ne 0 ]; then
                continue
              fi
              result
              continue
            fi
            else
            echo "ğŸ”´$apps éƒ¨ç½²æœªæˆåŠŸï¼Œè¯·è‡ªæŸ¥å‚æ•°è®¾ç½®æ˜¯å¦æœ‰è¯¯ï¼Œç©ºé—´æ˜¯å¦è¢«åˆ é™¤"
            fi
          done
